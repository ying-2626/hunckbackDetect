<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SittingWatch - å®æ—¶å§¿åŠ¿ç›‘æµ‹ç³»ç»Ÿ</title>
    <link rel="stylesheet" href="../css/index.css">
    <style>
        .report-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-top: 20px;
        }

        @media (max-width: 768px) {
            .report-grid {
                grid-template-columns: 1fr;
            }
        }

        .report-card {
            background: #fff;
            border-radius: 8px;
            padding: 15px;
            border-left: 4px solid #3498db;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .report-card h4 {
            margin-top: 0;
            color: #2c3e50;
            border-bottom: 1px solid #eee;
            padding-bottom: 8px;
            margin-bottom: 10px;
        }

        .report-content {
            font-size: 14px;
            line-height: 1.6;
            color: #555;
            white-space: pre-wrap;
        }

        .report-card.danger {
            border-left-color: #e74c3c;
        }

        .report-card.warning {
            border-left-color: #f39c12;
        }

        .report-card.success {
            border-left-color: #2ecc71;
        }

        .report-card.info {
            border-left-color: #3498db;
        }
    </style>
</head>

<body>
    <nav class="navbar">
        <div class="logo">SittingWatch</div>
        <ul class="nav-links">
            <li><a href="#" class="active">å§¿æ€åˆ†æ</a></li>
            <li><a href="./daily_report.html">åˆ†ææŠ¥å‘Š</a></li>
            <li><a href="./health_guide.html">å¥åº·æŒ‡å—</a></li>
            <li><a href="./login.html">é€€å‡ºç™»å½•</a></li>
        </ul>
    </nav>

    <div class="container">
        <div class="header">
            <h1>æ™ºèƒ½åå§¿ç›‘æµ‹ç³»ç»Ÿ</h1>
            <p>å®æ—¶ç›‘æµ‹æ‚¨çš„åå§¿çŠ¶æ€ï¼Œé¢„é˜²ä¸è‰¯å§¿åŠ¿å¸¦æ¥çš„å¥åº·é—®é¢˜</p>
        </div>

        <div class="tabs">
            <div class="tab active" id="live-tab">å®æ—¶ç›‘æ§</div>
            <div class="tab" id="upload-tab">å›¾ç‰‡åˆ†æ</div>
        </div>

        <div id="live-content" class="content-section">
            <div class="card">
                <h2>å®æ—¶å§¿åŠ¿ç›‘æµ‹</h2>
                <p>ç³»ç»Ÿæ­£åœ¨é€šè¿‡æ‘„åƒå¤´å®æ—¶ç›‘æµ‹æ‚¨çš„åå§¿ï¼Œå½“æ£€æµ‹åˆ°ä¸è‰¯å§¿åŠ¿æ—¶ä¼šç«‹å³æé†’æ‚¨ã€‚</p>

                <div class="live-feed-container">
                    <img src="/video_feed" id="live-feed" alt="å®æ—¶æ£€æµ‹ç”»é¢">
                </div>

                <div class="camera-controls">
                    <button class="btn btn-primary" id="start-btn">
                        <i>â–¶</i> å¼€å§‹ç›‘æµ‹
                    </button>
                    <button class="btn btn-outline" id="pause-btn">
                        <i>â¸</i> æš‚åœç›‘æµ‹
                    </button>
                </div>
            </div>
        </div>

        <div id="upload-content" class="content-section" style="display:none;">
            <div class="card">
                <h2>å›¾ç‰‡å§¿åŠ¿åˆ†æ</h2>
                <p>ä¸Šä¼ ä¸€å¼ åŒ…å«äººç‰©çš„å›¾ç‰‡ï¼Œç³»ç»Ÿå°†åˆ†æå›¾ç‰‡ä¸­çš„å§¿åŠ¿å¹¶ç»™å‡ºè¯„ä¼°æŠ¥å‘Šã€‚</p>

                <div class="upload-container">
                    <form id="analyze-form">
                        <div class="form-group">
                            <div class="file-input-container" id="file-drop-area">
                                <i>ğŸ“</i>
                                <p>æ‹–æ”¾å›¾ç‰‡åˆ°æ­¤å¤„æˆ–ç‚¹å‡»é€‰æ‹©æ–‡ä»¶</p>
                                <p class="small">æ”¯æŒ JPGæ ¼å¼ï¼Œæœ€å¤§ 5MB</p>
                                <input type="file" name="image" id="image-input" accept="image/*" required>
                                <div id="file-name"></div>
                            </div>
                        </div>

                        <button type="submit" class="btn btn-primary"
                            style="width:auto;display:block;margin:0 auto;text-align:center;">
                            <span style="display:inline-block;width:100%;text-align:center;">åˆ†æå§¿åŠ¿</span>
                        </button>
                    </form>

                    <div id="analyze-result">
                        <div class="loading" style="display: none;">
                            <div class="spinner"></div>
                            <p>æ­£åœ¨åˆ†ææ‚¨çš„å§¿åŠ¿ï¼Œè¯·ç¨å€™...</p>
                        </div>

                        <!-- AI åˆ†ææŠ¥å‘Šå±•ç¤ºåŒº -->
                        <div id="ai-report-container" style="display: none; margin-top: 20px;">
                            <div class="card" style="background: #f8f9fa; box-shadow: none; border: 1px solid #e9ecef;">
                                <h3
                                    style="color: #2c3e50; border-bottom: 2px solid #3498db; padding-bottom: 10px; margin-bottom: 15px;">
                                    ğŸ¤– AI æ™ºèƒ½åˆ†ææŠ¥å‘Š
                                </h3>

                                <div class="report-grid">
                                    <div class="report-card info">
                                        <h4>ğŸ§˜ å§¿æ€åˆ†æ</h4>
                                        <div id="report-posture" class="report-content">æš‚æ— æ•°æ®</div>
                                    </div>
                                    <div class="report-card warning">
                                        <h4>ğŸ” æˆå› åˆ†æ</h4>
                                        <div id="report-causes" class="report-content">æš‚æ— æ•°æ®</div>
                                    </div>
                                    <div class="report-card danger">
                                        <h4>âš ï¸ å¥åº·å±å®³</h4>
                                        <div id="report-risks" class="report-content">æš‚æ— æ•°æ®</div>
                                    </div>
                                    <div class="report-card success">
                                        <h4>ğŸ’¡ çŸ«æ­£å»ºè®®</h4>
                                        <div id="report-suggestions" class="report-content">æš‚æ— æ•°æ®</div>
                                    </div>
                                </div>

                                <!-- å…¼å®¹æ—§çš„æ˜¾ç¤ºåŒºåŸŸï¼Œå¦‚æœè§£æJSONå¤±è´¥ -->
                                <div id="ai-analysis-content"
                                    style="white-space: pre-wrap; line-height: 1.8; color: #444; font-size: 15px; display: none; margin-top: 15px;">
                                </div>
                            </div>
                        </div>

                        <!-- ä¿ç•™åŸæœ‰çš„ result-grid ç»“æ„ä½†éšè—ï¼Œæˆ–è€…ç›´æ¥æ›¿æ¢ã€‚ä¸ºäº†å…¼å®¹æ€§ï¼Œæˆ‘è¿™é‡Œæ›¿æ¢å®ƒï¼Œ
                             å› ä¸ºåŸæ¥çš„ metric-card æ˜¯ä¸“é—¨ä¸º good/bad è®¾è®¡çš„ã€‚
                             å¦‚æœè¿˜éœ€è¦æ˜¾ç¤º MediaPipe çš„å‡ ä½•åˆ†æç»“æœï¼Œé‚£ä¸ªæ˜¯åœ¨ updateAnalyzeResult é‡Œå¤„ç†çš„ã€‚
                             æ³¨æ„ï¼šupdateAnalyzeResult å¯èƒ½ä¼šæ“ä½œå…¶ä»– DOM å…ƒç´ ï¼Œæˆ‘éœ€è¦æ£€æŸ¥ä¸€ä¸‹ã€‚
                             åˆšæ‰çš„ä»£ç  Read æ²¡æ˜¾ç¤º updateAnalyzeResult çš„å®ç°ï¼Œæˆ‘æœ€å¥½å†è¯»ä¸€ä¸‹åé¢ã€‚
                        -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="footer">
        <p>SittingWatch æ™ºèƒ½åå§¿ç›‘æµ‹ç³»ç»Ÿ | è®©å¥åº·å§¿åŠ¿æˆä¸ºä¹ æƒ¯</p>
    </div>

    <script>
        // åˆ‡æ¢æ ‡ç­¾é¡µåŠŸèƒ½
        document.getElementById('live-tab').addEventListener('click', function () {
            document.getElementById('live-content').style.display = 'block';
            document.getElementById('upload-content').style.display = 'none';
            document.getElementById('live-tab').classList.add('active');
            document.getElementById('upload-tab').classList.remove('active');
        });

        document.getElementById('upload-tab').addEventListener('click', function () {
            document.getElementById('upload-content').style.display = 'block';
            document.getElementById('live-content').style.display = 'none';
            document.getElementById('upload-tab').classList.add('active');
            document.getElementById('live-tab').classList.remove('active');
        });

        // æ–‡ä»¶ä¸Šä¼ äº¤äº’
        const fileInput = document.getElementById('image-input');
        const fileName = document.getElementById('file-name');
        const dropArea = document.getElementById('file-drop-area');
        const analyzeForm = document.getElementById('analyze-form');
        const analyzeResult = document.getElementById('analyze-result');

        fileInput.addEventListener('change', function (e) {
            if (e.target.files.length) {
                fileName.textContent = 'å·²é€‰æ‹©: ' + e.target.files[0].name;
            }
        });

        // æ‹–æ”¾æ–‡ä»¶åŠŸèƒ½
        dropArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropArea.style.borderColor = '#4A6D7A';
            dropArea.style.backgroundColor = 'rgba(74, 109, 122, 0.1)';
        });

        dropArea.addEventListener('dragleave', () => {
            dropArea.style.borderColor = '#E2E8F0';
            dropArea.style.backgroundColor = '#F5F8FA';
        });

        dropArea.addEventListener('drop', (e) => {
            e.preventDefault();
            dropArea.style.borderColor = '#E2E8F0';
            dropArea.style.backgroundColor = '#F5F8FA';

            if (e.dataTransfer.files.length) {
                fileInput.files = e.dataTransfer.files;
                fileName.textContent = 'å·²é€‰æ‹©: ' + e.dataTransfer.files[0].name;
            }
        });

        // ç‚¹å‡»åŒºåŸŸè§¦å‘æ–‡ä»¶é€‰æ‹©ï¼ˆé˜²æ­¢é‡å¤å¼¹çª—å’Œé‡å¤ç»‘å®šï¼‰
        dropArea.addEventListener('click', (e) => {
            // åªåœ¨ç‚¹å‡»å®¹å™¨æœ¬èº«æ—¶è§¦å‘ï¼Œç‚¹å‡» input ä¸è§¦å‘
            if (e.target === dropArea) {
                fileInput.click();
            }
        });


        if (!analyzeForm.dataset.bound) {
            analyzeForm.addEventListener('submit', async function (e) {
                e.preventDefault();
                console.log("è¡¨å•æäº¤äº‹ä»¶è§¦å‘"); // è°ƒè¯•æ—¥å¿—

                if (!fileInput.files || fileInput.files.length === 0) {
                    alert('è¯·é€‰æ‹©ä¸€å¼ å›¾ç‰‡è¿›è¡Œåˆ†æ');
                    return;
                }

                // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                showLoadingState();

                try {
                    const formData = new FormData();
                    formData.append('image', fileInput.files[0]);

                    // è°ƒç”¨ /classify æ¥å£
                    let classifyData = null;
                    try {
                        const classifyResponse = await fetch('/classify', {
                            method: 'POST',
                            body: formData
                        });

                        const classifyText = await classifyResponse.text();
                        classifyData = JSON.parse(classifyText);
                        console.log("åˆ†ç±»è§£æåçš„JSONï¼š", classifyData);

                        if (!classifyResponse.ok) {
                            throw new Error(classifyData.error || `åˆ†ç±»å¤±è´¥: ${classifyResponse.status}`);
                        }

                        // æ›´æ–°å§¿æ€æ£€æµ‹ç»“æœæ˜¾ç¤º
                        updatePostureResult(classifyData);
                    } catch (classifyError) {
                        console.error("åˆ†ç±»å¼‚å¸¸ï¼š", classifyError);
                        if (classifyError && classifyError.stack) {
                            console.error("åˆ†ç±»å¼‚å¸¸å †æ ˆï¼š", classifyError.stack);
                        }
                        updatePostureResult({ posture: 'unknown', confidence: 0.0 });
                        showError('åˆ†ç±»å¤±è´¥', 'åˆ†ç±»å¤±è´¥ï¼Œè¯·ç¨åå†è¯•');
                    }

                    // è°ƒç”¨ /analyze æ¥å£
                    try {
                        const analyzeResponse = await fetch('/analyze', {
                            method: 'POST',
                            body: formData
                        });

                        const analyzeText = await analyzeResponse.text();
                        const analyzeData = JSON.parse(analyzeText);
                        console.log("åˆ†æè§£æåçš„JSONï¼š", analyzeData);

                        if (!analyzeResponse.ok) {
                            throw new Error(analyzeData.error || `åˆ†æå¤±è´¥: ${analyzeResponse.status}`);
                        }

                        // ç”Ÿæˆå›¾ç‰‡URL
                        let imgUrl;
                        if (analyzeData.image_base64) {
                            imgUrl = `data:image/jpeg;base64,${analyzeData.image_base64}`;
                        } else {
                            // å…¼å®¹æ—§æ¨¡å¼
                            imgUrl = `/static/tmp/${encodeURIComponent(analyzeData.filename)}`;
                        }

                        // æ˜¾ç¤ºåˆ†æç»“æœ - åŒ¹é…åç«¯è¿”å›çš„æ•°æ®ç»“æ„
                        updateAnalyzeResult(analyzeData, imgUrl);

                    } catch (analyzeError) {
                        console.error("åˆ†æå¼‚å¸¸ï¼š", analyzeError);
                        if (analyzeError && analyzeError.stack) {
                            console.error("åˆ†æå¼‚å¸¸å †æ ˆï¼š", analyzeError.stack);
                        }
                        showError('åˆ†æå¤±è´¥', 'åˆ†æå¤±è´¥ï¼Œè¯·ç¨åå†è¯•');
                    }

                } finally {
                    // éšè—åŠ è½½çŠ¶æ€
                    hideLoadingState();
                }
            });
            analyzeForm.dataset.bound = "true";
        }

        // è¾…åŠ©å‡½æ•°
        function showLoadingState() {
            document.querySelector('#analyze-result .loading').style.display = 'block';
            const reportContainer = document.getElementById('ai-report-container');
            if (reportContainer) reportContainer.style.display = 'none';

            // éšè—å¯èƒ½å­˜åœ¨çš„ä¸Šä¸€æ¬¡åˆ†æç»“æœ
            const summary = document.querySelector('.analysis-summary');
            if (summary) summary.style.display = 'none';
        }

        function hideLoadingState() {
            document.querySelector('#analyze-result .loading').style.display = 'none';
        }

        let lastClassifyResult = { posture: 'unknown', confidence: 0.0 };

        function updatePostureResult(data) {
            const reportContainer = document.getElementById('ai-report-container');
            const analysisContent = document.getElementById('ai-analysis-content');
            const gridContainer = document.querySelector('.report-grid');

            if (data.analysis) {
                if (typeof data.analysis === 'object') {
                    // å¦‚æœæ˜¯ JSON å¯¹è±¡ï¼Œæ˜¾ç¤ºåˆ†æ 
                    if (gridContainer) gridContainer.style.display = 'grid';
                    if (analysisContent) analysisContent.style.display = 'none';

                    document.getElementById('report-posture').textContent = data.analysis.posture_analysis || 'æ— æ•°æ®';
                    document.getElementById('report-causes').textContent = data.analysis.causes_analysis || 'æ— æ•°æ®';
                    document.getElementById('report-risks').textContent = data.analysis.harm_analysis || 'æ— æ•°æ®';
                    document.getElementById('report-suggestions').textContent = data.analysis.correction_suggestions || 'æ— æ•°æ®';
                } else {
                    // å¦‚æœæ˜¯çº¯æ–‡æœ¬ï¼ˆå…¼å®¹æ—§é€»è¾‘ï¼‰ï¼Œæ˜¾ç¤ºå•ä¸€æ–‡æœ¬æ¡†
                    if (gridContainer) gridContainer.style.display = 'none';
                    if (analysisContent) {
                        analysisContent.style.display = 'block';
                        analysisContent.textContent = data.analysis;
                    }
                }

                if (reportContainer) reportContainer.style.display = 'block';
            }

            // å…¼å®¹ sitting_good/sitting_bad ç”¨äºåç»­ updateAnalyzeResult çš„é€»è¾‘
            let postureType = 'unknown';
            // ä¼˜å…ˆæ£€æŸ¥ posture å­—æ®µï¼ˆapp.py è¿”å›çš„æ–°æ ¼å¼ï¼‰
            if (data.posture === 'good' || data.posture === 'sitting_good') {
                postureType = 'good';
            } else if (data.posture === 'bad' || data.posture === 'sitting_bad') {
                postureType = 'bad';
            }
            // å…¼å®¹æ—§çš„ class å­—æ®µ
            else if (data.class === 'good' || data.class === 'sitting_good') {
                postureType = 'good';
            } else if (data.class === 'bad' || data.class === 'sitting_bad') {
                postureType = 'bad';
            }

            // ä¿å­˜åˆ†ç±»ç»“æœï¼Œä¾›åˆ†æç»“æœåŒºåŸŸä½¿ç”¨
            // ä¼˜å…ˆä½¿ç”¨ data.confidenceï¼Œå¦‚æœæ²¡æœ‰åˆ™å°è¯• data.conf
            const confidence = data.confidence !== undefined ? data.confidence : (data.conf || 0.0);
            lastClassifyResult = {
                posture: postureType,
                confidence: confidence,
                analysis: data.analysis // ä¿å­˜è¯¦ç»†åˆ†ææ•°æ®
            };
        }

        function updateAnalyzeResult(data, imgUrl) {
            // ä¿è¯ç»“æœåŒºåŸŸå¯è§
            document.getElementById('analyze-result').style.display = 'block';

            const analyzeResultDiv = document.querySelector('#analyze-result .analysis-summary');
            if (analyzeResultDiv) {
                analyzeResultDiv.remove();
            }

            // åŸºäºåˆ†ç±»ç»“æœçš„å§¿æ€æ–‡æœ¬
            let postureText = 'æœªçŸ¥';

            // è·å– AI åˆ†æå‡ºçš„å…·ä½“é—®é¢˜
            const aiIssues = lastClassifyResult.analysis && lastClassifyResult.analysis.detected_issues
                ? lastClassifyResult.analysis.detected_issues
                : [];

            if (lastClassifyResult.posture === 'good') {
                postureText = 'æ‚¨çš„åå§¿çŠ¶æ€è‰¯å¥½ï¼Œè¯·ç»§ç»­ä¿æŒï¼';
            } else if (lastClassifyResult.posture === 'bad') {
                if (aiIssues.length > 0) {
                    postureText = `æ£€æµ‹åˆ°åå§¿å¼‚å¸¸ï¼ˆ${aiIssues.join('ã€')}ï¼‰ï¼Œå»ºè®®è°ƒæ•´å§¿åŠ¿`;
                } else {
                    postureText = 'æ£€æµ‹åˆ°åå§¿å¼‚å¸¸ï¼Œå»ºè®®è°ƒæ•´å§¿åŠ¿';
                }
            } else {
                postureText = 'æœªèƒ½è¯†åˆ«æ‚¨çš„åå§¿çŠ¶æ€';
            }

            const newAnalyzeResult = document.createElement('div');
            newAnalyzeResult.classList.add('analysis-summary');

            // æ„å»ºå¯¹æ¯”åˆ†ææ–‡æ¡ˆ
            let comparisonHtml = '';
            // ç”¨æˆ·è¦æ±‚å‡ ä½•æ£€æµ‹ä»¥ posture_status ä¸ºå‡†
            const mpStatus = data.posture_status === 'å¼‚å¸¸' ? 'å¼‚å¸¸' : 'æ­£å¸¸';
            const aiStatus = lastClassifyResult.posture === 'bad' ? 'å¼‚å¸¸' : (lastClassifyResult.posture === 'good' ? 'æ­£å¸¸' : 'æœªçŸ¥');

            comparisonHtml = `<div style="margin-bottom: 15px; padding: 10px; background: #f0f7ff; border-radius: 5px; font-size: 14px;">
                <strong>ğŸ“Š åˆ†æå¯¹æ¯”ï¼š</strong><br>
                â€¢ å‡ ä½•ç®—æ³•æ£€æµ‹ï¼š<span style="color: ${mpStatus === 'å¼‚å¸¸' ? '#e74c3c' : '#2ecc71'}">${mpStatus}</span>
                <span style="color: #7f8c8d; font-size: 12px; margin-left: 5px;">(ç»¼åˆåˆ¤å®š: ${data.posture_status}, é©¼èƒŒåˆ¤å®š: ${data.hunchback_status})</span><br>
                â€¢ AI æ¨¡å‹è¯„ä¼°ï¼š<span style="color: ${aiStatus === 'å¼‚å¸¸' ? '#e74c3c' : (aiStatus === 'æ­£å¸¸' ? '#2ecc71' : '#95a5a6')}">${aiStatus}</span>
                ${aiStatus !== 'æœªçŸ¥' && mpStatus !== aiStatus ? '<br><span style="color: #f39c12; font-size: 12px;">(æ³¨ï¼šå½“ç»“æœä¸ä¸€è‡´æ—¶ï¼ŒAI æ¨¡å‹è¯„ä¼°é€šå¸¸æ›´å…·ç»¼åˆæ€§)</span>' : ''}
            </div>`;

            newAnalyzeResult.innerHTML = `
                <h3>å§¿åŠ¿è¯„ä¼°</h3>
                ${comparisonHtml}
                <p style="font-size: 16px; font-weight: bold; margin-bottom: 10px;">
                    æœ€ç»ˆç»“è®ºï¼š${postureText}
                </p>

                <div class="result-image">
                    <h3>å§¿åŠ¿æ ‡è®°å›¾</h3>
                    <img src="${imgUrl}" alt="å§¿åŠ¿åˆ†æç»“æœ" onerror="this.src='https://images.unsplash.com/photo-1512941937669-90a1b58e7e9c?crop=entropy&cs=tinysrgb&fit=max&fm=jpg&ixid=MnwxfDB8MXxyYW5kb218MHx8cG9zdHVyZXx8fHx8fDE2ODc4MzYyODU&ixlib=rb-4.0.3&q=80&utm_campaign=api-credit&utm_medium=referral&utm_source=unsplash_source&w=1080'">
                    <a href="${imgUrl}" download="å§¿åŠ¿åˆ†æç»“æœ.jpg" class="btn btn-outline">
                        <i>â¬‡ï¸</i> ä¸‹è½½æ ‡è®°å›¾
                    </a>
                </div>

            `;
            document.getElementById('analyze-result').appendChild(newAnalyzeResult);
        }

        function showError(title, message) {
            const errorDiv = document.createElement('div');
            errorDiv.classList.add('error');
            errorDiv.innerHTML = `
                <h3>${title}</h3>
                <p>${message}</p>
                <button class="btn btn-primary" onclick="location.reload()">é‡è¯•</button>
            `;
            document.getElementById('analyze-result').appendChild(errorDiv);
        }




        // å®æ—¶ç›‘æ§æŒ‰é’®åŠŸèƒ½
        document.getElementById('start-btn').addEventListener('click', function () {
            alert('å®æ—¶ç›‘æµ‹å·²å¯åŠ¨ï¼ç³»ç»Ÿå°†å®æ—¶åˆ†ææ‚¨çš„åå§¿ã€‚');
        });

        document.getElementById('pause-btn').addEventListener('click', function () {
            alert('å®æ—¶ç›‘æµ‹å·²æš‚åœã€‚');
        });
    </script>
</body>

</html>