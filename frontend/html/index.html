<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SittingWatch - å®æ—¶å§¿åŠ¿ç›‘æµ‹ç³»ç»Ÿ</title>
    <link rel="stylesheet" href="../css/index.css">
</head>
<body>
    <nav class="navbar">
        <div class="logo">SittingWatch</div>
        <ul class="nav-links">
            <li><a href="#" class="active">é¦–é¡µ</a></li>
            <li><a href="./daily_report.html">åˆ†ææŠ¥å‘Š</a></li>
            <li><a href="https://github.com/ying-2626/hunckbackDetect">ä½¿ç”¨æŒ‡å—</a></li>
            <li><a href="#">ä¸ªäººè´¦å·</a></li>
        </ul>
    </nav>

    <div class="container">
        <div class="header">
            <h1>æ™ºèƒ½åå§¿ç›‘æµ‹ç³»ç»Ÿ</h1>
            <p>å®æ—¶ç›‘æµ‹æ‚¨çš„åå§¿çŠ¶æ€ï¼Œé¢„é˜²ä¸è‰¯å§¿åŠ¿å¸¦æ¥çš„å¥åº·é—®é¢˜</p>
        </div>

        <div class="tabs">
            <div class="tab active" id="live-tab">å®æ—¶ç›‘æ§</div>
            <div class="tab" id="upload-tab">å›¾ç‰‡åˆ†æ</div>
        </div>

        <div id="live-content" class="content-section">
            <div class="card">
                <h2>å®æ—¶å§¿åŠ¿ç›‘æµ‹</h2>
                <p>ç³»ç»Ÿæ­£åœ¨é€šè¿‡æ‘„åƒå¤´å®æ—¶ç›‘æµ‹æ‚¨çš„åå§¿ï¼Œå½“æ£€æµ‹åˆ°ä¸è‰¯å§¿åŠ¿æ—¶ä¼šç«‹å³æé†’æ‚¨ã€‚</p>

                <div class="live-feed-container">
                    <img src="http://localhost:5000/video_feed" id="live-feed" alt="å®æ—¶æ£€æµ‹ç”»é¢">
                </div>

                <div class="camera-controls">
                    <button class="btn btn-primary" id="start-btn">
                        <i>â–¶</i> å¼€å§‹ç›‘æµ‹
                    </button>
                    <button class="btn btn-outline" id="pause-btn">
                        <i>â¸</i> æš‚åœç›‘æµ‹
                    </button>
                </div>
            </div>
        </div>

        <div id="upload-content" class="content-section" style="display:none;">
            <div class="card">
                <h2>å›¾ç‰‡å§¿åŠ¿åˆ†æ</h2>
                <p>ä¸Šä¼ ä¸€å¼ åŒ…å«äººç‰©çš„å›¾ç‰‡ï¼Œç³»ç»Ÿå°†åˆ†æå›¾ç‰‡ä¸­çš„å§¿åŠ¿å¹¶ç»™å‡ºè¯„ä¼°æŠ¥å‘Šã€‚</p>

                <div class="upload-container">
                    <form id="analyze-form">
                        <div class="form-group">
                            <div class="file-input-container" id="file-drop-area">
                                <i>ğŸ“</i>
                                <p>æ‹–æ”¾å›¾ç‰‡åˆ°æ­¤å¤„æˆ–ç‚¹å‡»é€‰æ‹©æ–‡ä»¶</p>
                                <p class="small">æ”¯æŒ JPGæ ¼å¼ï¼Œæœ€å¤§ 5MB</p>
                                <input type="file" name="image" id="image-input" accept="image/*" required>
                                <div id="file-name"></div>
                            </div>
                        </div>

                        <button type="submit" class="btn btn-primary" style="width:auto;display:block;margin:0 auto;text-align:center;">
                            <span style="display:inline-block;width:100%;text-align:center;">åˆ†æå§¿åŠ¿</span>
                        </button>
                    </form>

                    <div id="analyze-result">
                        <div class="loading" style="display: none;">
                            <div class="spinner"></div>
                            <p>æ­£åœ¨åˆ†ææ‚¨çš„å§¿åŠ¿ï¼Œè¯·ç¨å€™...</p>
                        </div>
                        <div class="result-grid" style="display: none;">
                            <div class="metric-card">
                                <h3>é©¼èƒŒå§¿æ€æ£€æµ‹</h3>
                                <div class="status-badge" id="posture-status"></div>
                            </div>
                            <div class="metric-card">
                                <h3>ç½®ä¿¡åº¦</h3>
                                <div id="confidence-value"></div>
                                <p class="small">0-1 æ•°å€¼è¶Šå¤§ï¼Œå¯ä¿¡åº¦è¶Šé«˜</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="footer">
        <p>SittingWatch æ™ºèƒ½åå§¿ç›‘æµ‹ç³»ç»Ÿ | è®©å¥åº·å§¿åŠ¿æˆä¸ºä¹ æƒ¯</p>
    </div>

    <script>
        // åˆ‡æ¢æ ‡ç­¾é¡µåŠŸèƒ½
        document.getElementById('live-tab').addEventListener('click', function() {
            document.getElementById('live-content').style.display = 'block';
            document.getElementById('upload-content').style.display = 'none';
            document.getElementById('live-tab').classList.add('active');
            document.getElementById('upload-tab').classList.remove('active');
        });

        document.getElementById('upload-tab').addEventListener('click', function() {
            document.getElementById('upload-content').style.display = 'block';
            document.getElementById('live-content').style.display = 'none';
            document.getElementById('upload-tab').classList.add('active');
            document.getElementById('live-tab').classList.remove('active');
        });

        // æ–‡ä»¶ä¸Šä¼ äº¤äº’
        const fileInput = document.getElementById('image-input');
        const fileName = document.getElementById('file-name');
        const dropArea = document.getElementById('file-drop-area');
        const analyzeForm = document.getElementById('analyze-form');
        const analyzeResult = document.getElementById('analyze-result');

        fileInput.addEventListener('change', function(e) {
            if (e.target.files.length) {
                fileName.textContent = 'å·²é€‰æ‹©: ' + e.target.files[0].name;
            }
        });

        // æ‹–æ”¾æ–‡ä»¶åŠŸèƒ½
        dropArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropArea.style.borderColor = '#4A6D7A';
            dropArea.style.backgroundColor = 'rgba(74, 109, 122, 0.1)';
        });

        dropArea.addEventListener('dragleave', () => {
            dropArea.style.borderColor = '#E2E8F0';
            dropArea.style.backgroundColor = '#F5F8FA';
        });

        dropArea.addEventListener('drop', (e) => {
            e.preventDefault();
            dropArea.style.borderColor = '#E2E8F0';
            dropArea.style.backgroundColor = '#F5F8FA';

            if (e.dataTransfer.files.length) {
                fileInput.files = e.dataTransfer.files;
                fileName.textContent = 'å·²é€‰æ‹©: ' + e.dataTransfer.files[0].name;
            }
        });

        // ç‚¹å‡»åŒºåŸŸè§¦å‘æ–‡ä»¶é€‰æ‹©ï¼ˆé˜²æ­¢é‡å¤å¼¹çª—å’Œé‡å¤ç»‘å®šï¼‰
        dropArea.addEventListener('click', (e) => {
            // åªåœ¨ç‚¹å‡»å®¹å™¨æœ¬èº«æ—¶è§¦å‘ï¼Œç‚¹å‡» input ä¸è§¦å‘
            if (e.target === dropArea) {
                fileInput.click();
            }
        });


  if (!analyzeForm.dataset.bound) {
    analyzeForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        console.log("è¡¨å•æäº¤äº‹ä»¶è§¦å‘"); // è°ƒè¯•æ—¥å¿—

        if (!fileInput.files || fileInput.files.length === 0) {
            alert('è¯·é€‰æ‹©ä¸€å¼ å›¾ç‰‡è¿›è¡Œåˆ†æ');
            return;
        }

        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        showLoadingState();

        try {
            const formData = new FormData();
            formData.append('image', fileInput.files[0]);

            // è°ƒç”¨ /classify æ¥å£
            let classifyData = null;
            try {
                const classifyResponse = await fetch('http://localhost:5000/classify', {
                    method: 'POST',
                    body: formData
                });

                const classifyText = await classifyResponse.text();
                classifyData = JSON.parse(classifyText);
                console.log("åˆ†ç±»è§£æåçš„JSONï¼š", classifyData);

                if (!classifyResponse.ok) {
                    throw new Error(classifyData.error || `åˆ†ç±»å¤±è´¥: ${classifyResponse.status}`);
                }

                // æ›´æ–°å§¿æ€æ£€æµ‹ç»“æœæ˜¾ç¤º
                updatePostureResult(classifyData);
            } catch (classifyError) {
                console.error("åˆ†ç±»å¼‚å¸¸ï¼š", classifyError);
                if (classifyError && classifyError.stack) {
                    console.error("åˆ†ç±»å¼‚å¸¸å †æ ˆï¼š", classifyError.stack);
                }
                updatePostureResult({ posture: 'unknown', confidence: 0.0 });
                showError('åˆ†ç±»å¤±è´¥', 'åˆ†ç±»å¤±è´¥ï¼Œè¯·ç¨åå†è¯•');
            }

            // è°ƒç”¨ /analyze æ¥å£
            try {
                const analyzeResponse = await fetch('http://localhost:5000/analyze', {
                    method: 'POST',
                    body: formData
                });

                const analyzeText = await analyzeResponse.text();
                const analyzeData = JSON.parse(analyzeText);
                console.log("åˆ†æè§£æåçš„JSONï¼š", analyzeData);

                if (!analyzeResponse.ok) {
                    throw new Error(analyzeData.error || `åˆ†æå¤±è´¥: ${analyzeResponse.status}`);
                }

                // ç”Ÿæˆå›¾ç‰‡URL - æ³¨æ„åç«¯è¿”å›çš„å­—æ®µæ˜¯filename
                const imgUrl = `/static/tmp/${encodeURIComponent(analyzeData.filename)}`;

                // æ˜¾ç¤ºåˆ†æç»“æœ - åŒ¹é…åç«¯è¿”å›çš„æ•°æ®ç»“æ„
                updateAnalyzeResult(analyzeData, imgUrl);

            } catch (analyzeError) {
                console.error("åˆ†æå¼‚å¸¸ï¼š", analyzeError);
                if (analyzeError && analyzeError.stack) {
                    console.error("åˆ†æå¼‚å¸¸å †æ ˆï¼š", analyzeError.stack);
                }
                showError('åˆ†æå¤±è´¥', 'åˆ†æå¤±è´¥ï¼Œè¯·ç¨åå†è¯•');
            }

        } finally {
            // éšè—åŠ è½½çŠ¶æ€
            hideLoadingState();
        }
    });
    analyzeForm.dataset.bound = "true";
}

        // è¾…åŠ©å‡½æ•°
        function showLoadingState() {
            document.querySelector('#analyze-result .loading').style.display = 'block';
            document.querySelector('#analyze-result .result-grid').style.display = 'none';
        }

        function hideLoadingState() {
            document.querySelector('#analyze-result .loading').style.display = 'none';
            document.querySelector('#analyze-result .result-grid').style.display = 'flex';
        }

        let lastClassifyResult = { posture: 'unknown', confidence: 0.0 };

        function updatePostureResult(data) {
            const postureStatusElement = document.getElementById('posture-status');
            const confidenceValueElement = document.getElementById('confidence-value');

            // å…¼å®¹ sitting_good/sitting_bad
            let postureType = 'unknown';
            if (data.posture === 'good' || data.posture === 'sitting_good') {
                postureType = 'good';
            } else if (data.posture === 'bad' || data.posture === 'sitting_bad') {
                postureType = 'bad';
            }

            // ä¿å­˜åˆ†ç±»ç»“æœï¼Œä¾›åˆ†æç»“æœåŒºåŸŸä½¿ç”¨
            lastClassifyResult = { posture: postureType, confidence: data.confidence };

            postureStatusElement.classList.remove('status-good', 'status-poor');
            if (postureType === 'good') {
                postureStatusElement.classList.add('status-good');
                postureStatusElement.textContent = 'å§¿æ€è‰¯å¥½';
            } else if (postureType === 'bad') {
                postureStatusElement.classList.add('status-poor');
                postureStatusElement.textContent = 'å§¿æ€ä¸è‰¯';
            } else {
                postureStatusElement.textContent = 'æœªçŸ¥';
            }

            confidenceValueElement.textContent = `ç½®ä¿¡åº¦: ${data.confidence ? data.confidence.toFixed(3) : 'N/A'}`;
        }

        function updateAnalyzeResult(data, imgUrl) {
            // ä¿è¯ç»“æœåŒºåŸŸå¯è§
            document.getElementById('analyze-result').style.display = 'block';

            const analyzeResultDiv = document.querySelector('#analyze-result .analysis-summary');
            if (analyzeResultDiv) {
                analyzeResultDiv.remove();
            }

            // åŸºäºåˆ†ç±»ç»“æœçš„å§¿æ€æ–‡æœ¬
            let postureText = 'æœªçŸ¥';
            if (lastClassifyResult.posture === 'good') {
                postureText = 'æ‚¨çš„åå§¿çŠ¶æ€è‰¯å¥½ï¼Œè¯·ç»§ç»­ä¿æŒï¼';
            } else if (lastClassifyResult.posture === 'bad') {
                postureText = 'æ£€æµ‹åˆ°åå§¿å¼‚å¸¸ï¼Œå»ºè®®è°ƒæ•´å§¿åŠ¿';
            } else {
                postureText = 'æœªèƒ½è¯†åˆ«æ‚¨çš„åå§¿çŠ¶æ€';
            }

            const newAnalyzeResult = document.createElement('div');
            newAnalyzeResult.classList.add('analysis-summary');
            newAnalyzeResult.innerHTML = `
                <h3>å§¿åŠ¿è¯„ä¼°</h3>
                <p>${postureText}${data.hunchback_status === 'å¼‚å¸¸' ? 'ï¼Œå­˜åœ¨é©¼èƒŒç°è±¡' : ''}</p>

                <div class="result-image">
                    <h3>å§¿åŠ¿æ ‡è®°å›¾</h3>
                    <img src="${imgUrl}" alt="å§¿åŠ¿åˆ†æç»“æœ" onerror="this.src='https://images.unsplash.com/photo-1512941937669-90a1b58e7e9c?crop=entropy&cs=tinysrgb&fit=max&fm=jpg&ixid=MnwxfDB8MXxyYW5kb218MHx8cG9zdHVyZXx8fHx8fDE2ODc4MzYyODU&ixlib=rb-4.0.3&q=80&utm_campaign=api-credit&utm_medium=referral&utm_source=unsplash_source&w=1080'">
                    <a href="${imgUrl}" download="å§¿åŠ¿åˆ†æç»“æœ.jpg" class="btn btn-outline">
                        <i>â¬‡ï¸</i> ä¸‹è½½æ ‡è®°å›¾
                    </a>
                </div>

            `;
            document.getElementById('analyze-result').appendChild(newAnalyzeResult);
        }

        function showError(title, message) {
            const errorDiv = document.createElement('div');
            errorDiv.classList.add('error');
            errorDiv.innerHTML = `
                <h3>${title}</h3>
                <p>${message}</p>
                <button class="btn btn-primary" onclick="location.reload()">é‡è¯•</button>
            `;
            document.getElementById('analyze-result').appendChild(errorDiv);
        }




        // å®æ—¶ç›‘æ§æŒ‰é’®åŠŸèƒ½
        document.getElementById('start-btn').addEventListener('click', function() {
            alert('å®æ—¶ç›‘æµ‹å·²å¯åŠ¨ï¼ç³»ç»Ÿå°†å®æ—¶åˆ†ææ‚¨çš„åå§¿ã€‚');
        });

        document.getElementById('pause-btn').addEventListener('click', function() {
            alert('å®æ—¶ç›‘æµ‹å·²æš‚åœã€‚');
        });
    </script>
</body>
</html>
