<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SittingWatch - å®æ—¶å§¿åŠ¿ç›‘æµ‹ç³»ç»Ÿ</title>
    <link rel="stylesheet" href="../css/index.css">
</head>
<body>
    <nav class="navbar">
        <div class="logo">SittingWatch</div>
        <ul class="nav-links">
            <li><a href="#" class="active">é¦–é¡µ</a></li>
            <li><a href="https://github.com/ying-2626/hunckbackDetect">ä½¿ç”¨æŒ‡å—</a></li>
            <li><a href="#">æ•°æ®åˆ†æ</a></li>
            <li><a href="#">ä¸ªäººè´¦å·</a></li>
        </ul>
    </nav>

    <div class="container">
        <div class="header">
            <h1>æ™ºèƒ½åå§¿ç›‘æµ‹ç³»ç»Ÿ</h1>
            <p>å®æ—¶ç›‘æµ‹æ‚¨çš„åå§¿çŠ¶æ€ï¼Œé¢„é˜²ä¸è‰¯å§¿åŠ¿å¸¦æ¥çš„å¥åº·é—®é¢˜</p>
        </div>

        <div class="tabs">
            <div class="tab active" id="live-tab">å®æ—¶ç›‘æ§</div>
            <div class="tab" id="upload-tab">å›¾ç‰‡åˆ†æ</div>
        </div>

        <div id="live-content" class="content-section">
            <div class="card">
                <h2>å®æ—¶å§¿åŠ¿ç›‘æµ‹</h2>
                <p>ç³»ç»Ÿæ­£åœ¨é€šè¿‡æ‘„åƒå¤´å®æ—¶ç›‘æµ‹æ‚¨çš„åå§¿ï¼Œå½“æ£€æµ‹åˆ°ä¸è‰¯å§¿åŠ¿æ—¶ä¼šç«‹å³æé†’æ‚¨ã€‚</p>

                <div class="live-feed-container">
                    <img src="http://localhost:5000/video_feed" id="live-feed" alt="å®æ—¶æ£€æµ‹ç”»é¢">
                </div>

                <div class="camera-controls">
                    <button class="btn btn-primary" id="start-btn">
                        <i>â–¶</i> å¼€å§‹ç›‘æµ‹
                    </button>
                    <button class="btn btn-outline" id="pause-btn">
                        <i>â¸</i> æš‚åœç›‘æµ‹
                    </button>
                </div>
            </div>
        </div>

        <div id="upload-content" class="content-section" style="display:none;">
            <div class="card">
                <h2>å›¾ç‰‡å§¿åŠ¿åˆ†æ</h2>
                <p>ä¸Šä¼ ä¸€å¼ åŒ…å«äººç‰©çš„å›¾ç‰‡ï¼Œç³»ç»Ÿå°†åˆ†æå›¾ç‰‡ä¸­çš„å§¿åŠ¿å¹¶ç»™å‡ºè¯„ä¼°æŠ¥å‘Šã€‚</p>

                <div class="upload-container">
                    <form id="analyze-form">
                        <div class="form-group">
                            <div class="file-input-container" id="file-drop-area">
                                <i>ğŸ“</i>
                                <p>æ‹–æ”¾å›¾ç‰‡åˆ°æ­¤å¤„æˆ–ç‚¹å‡»é€‰æ‹©æ–‡ä»¶</p>
                                <p class="small">æ”¯æŒ JPG, PNG æ ¼å¼ï¼Œæœ€å¤§ 5MB</p>
                                <input type="file" name="image" id="image-input" accept="image/*" required>
                                <div id="file-name"></div>
                            </div>
                        </div>

                        <button type="submit" class="btn btn-primary" style="width:auto;display:block;margin:0 auto;text-align:center;">
                            <span style="display:inline-block;width:100%;text-align:center;">åˆ†æå§¿åŠ¿</span>
                        </button>
                    </form>

                    <div id="analyze-result">

                        <div class="result-image">
                            <h3>å§¿åŠ¿æ ‡è®°å›¾</h3>
                            <img src="" alt="å§¿åŠ¿åˆ†æç»“æœ" class="result-img">
                            <a href="#" download="å§¿åŠ¿åˆ†æç»“æœ.jpg" class="btn btn-outline download-link">
                                <i>â¬‡ï¸</i> ä¸‹è½½æ ‡è®°å›¾
                            </a>
                        </div>

                        <div class="report-actions">
                            <button class="btn btn-primary download-report">
                                <i>ğŸ“¥</i> ä¸‹è½½å®Œæ•´æŠ¥å‘Š
                            </button>
                        </div>

                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="footer">
        <p>SittingWatch æ™ºèƒ½åå§¿ç›‘æµ‹ç³»ç»Ÿ | è®©å¥åº·å§¿åŠ¿æˆä¸ºä¹ æƒ¯</p>
    </div>

    <script>
        // åˆ‡æ¢æ ‡ç­¾é¡µåŠŸèƒ½
        document.getElementById('live-tab').addEventListener('click', function() {
            document.getElementById('live-content').style.display = 'block';
            document.getElementById('upload-content').style.display = 'none';
            document.getElementById('live-tab').classList.add('active');
            document.getElementById('upload-tab').classList.remove('active');
        });

        document.getElementById('upload-tab').addEventListener('click', function() {
            document.getElementById('upload-content').style.display = 'block';
            document.getElementById('live-content').style.display = 'none';
            document.getElementById('upload-tab').classList.add('active');
            document.getElementById('live-tab').classList.remove('active');
        });

        // æ–‡ä»¶ä¸Šä¼ äº¤äº’
        const fileInput = document.getElementById('image-input');
        const fileName = document.getElementById('file-name');
        const dropArea = document.getElementById('file-drop-area');
        const analyzeForm = document.getElementById('analyze-form');
        const analyzeResult = document.getElementById('analyze-result');

        fileInput.addEventListener('change', function(e) {
            if (e.target.files.length) {
                fileName.textContent = 'å·²é€‰æ‹©: ' + e.target.files[0].name;
            }
        });

        // æ‹–æ”¾æ–‡ä»¶åŠŸèƒ½
        dropArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropArea.style.borderColor = '#4A6D7A';
            dropArea.style.backgroundColor = 'rgba(74, 109, 122, 0.1)';
        });

        dropArea.addEventListener('dragleave', () => {
            dropArea.style.borderColor = '#E2E8F0';
            dropArea.style.backgroundColor = '#F5F8FA';
        });

        dropArea.addEventListener('drop', (e) => {
            e.preventDefault();
            dropArea.style.borderColor = '#E2E8F0';
            dropArea.style.backgroundColor = '#F5F8FA';

            if (e.dataTransfer.files.length) {
                fileInput.files = e.dataTransfer.files;
                fileName.textContent = 'å·²é€‰æ‹©: ' + e.dataTransfer.files[0].name;
            }
        });

        // ç‚¹å‡»åŒºåŸŸè§¦å‘æ–‡ä»¶é€‰æ‹©ï¼ˆé˜²æ­¢é‡å¤å¼¹çª—å’Œé‡å¤ç»‘å®šï¼‰
        dropArea.addEventListener('click', (e) => {
            // åªåœ¨ç‚¹å‡»å®¹å™¨æœ¬èº«æ—¶è§¦å‘ï¼Œç‚¹å‡» input ä¸è§¦å‘
            if (e.target === dropArea) {
                fileInput.click();
            }
        });

        // é˜²æ­¢é‡å¤ç»‘å®š submit äº‹ä»¶
        if (!analyzeForm.dataset.bound) {
            analyzeForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                console.log("è¡¨å•æäº¤äº‹ä»¶è§¦å‘"); // è°ƒè¯•æ—¥å¿—

                if (!fileInput.files || fileInput.files.length === 0) {
                    alert('è¯·é€‰æ‹©ä¸€å¼ å›¾ç‰‡è¿›è¡Œåˆ†æ');
                    return;
                }

                // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                    document.querySelector('#analyze-result').style.display = 'block';
                    document.querySelector('#analyze-result').innerHTML = `
                        <div class="loading">
                            <div class="spinner"></div>
                            <p>æ­£åœ¨åˆ†ææ‚¨çš„å§¿åŠ¿ï¼Œè¯·ç¨å€™...</p>
                        </div>
                    `;

                try {
                    const formData = new FormData();
                    formData.append('image', fileInput.files[0]);

                    const response = await fetch('http://localhost:5000/analyze', {
                        method: 'POST',
                        body: formData
                    });

                    const text = await response.text();
                    console.log("fetchå“åº”åŸå§‹æ–‡æœ¬ï¼š", text);

                    const data = JSON.parse(text);
                    console.log("è§£æåçš„JSONï¼š", data);

                    if (!response.ok) {
                        throw new Error(data.error || `åˆ†æå¤±è´¥: ${response.status}`);
                    }

                    // ç”Ÿæˆå›¾ç‰‡URL - æ³¨æ„åç«¯è¿”å›çš„å­—æ®µæ˜¯filename
                    const imgUrl = `/static/tmp/${encodeURIComponent(data.filename)}`;

                    // æ˜¾ç¤ºåˆ†æç»“æœ - åŒ¹é…åç«¯è¿”å›çš„æ•°æ®ç»“æ„
                    analyzeResult.innerHTML = `
                        <h2>å§¿åŠ¿åˆ†æç»“æœ</h2>
                        <div class="result-grid">
                            <div class="metric-card">
                                <h3>ä½å¤´æ£€æµ‹</h3>
                                <div class="status-badge ${data.posture_status === 'æ­£å¸¸' ? 'status-good' : 'status-poor'}">
                                    ${data.posture_status}
                                </div>
                            </div>
                            <div class="metric-card">
                                <h3>é©¼èƒŒæ£€æµ‹</h3>
                                <div class="status-badge ${data.hunchback_status === 'æ­£å¸¸' ? 'status-good' : 'status-poor'}">
                                    ${data.hunchback_status}
                                </div>
                            </div>
                        </div>

                        <div class="analysis-summary">
                            <h3>å§¿åŠ¿è¯„ä¼°</h3>
                            <p>${data.posture_status === 'æ­£å¸¸' ?
                                'æ‚¨çš„åå§¿çŠ¶æ€è‰¯å¥½ï¼Œè¯·ç»§ç»­ä¿æŒï¼' :
                                'æ£€æµ‹åˆ°åå§¿å¼‚å¸¸ï¼Œå»ºè®®è°ƒæ•´å§¿åŠ¿'} ${data.hunchback_status === 'å¼‚å¸¸' ? 'ï¼Œå­˜åœ¨é©¼èƒŒç°è±¡' : ''}</p>

                            <h3>ä¸“ä¸šå»ºè®®</h3>
                            <ul>
                                <li>è°ƒæ•´åº§æ¤…é«˜åº¦ä½¿åŒè„šå¹³æ”¾åœ°é¢</li>
                                <li>ä¿æŒèƒŒéƒ¨æŒºç›´ï¼Œé¿å…å‰å€¾</li>
                                <li>è°ƒæ•´æ˜¾ç¤ºå™¨é«˜åº¦ä¸è§†çº¿å¹³é½</li>
                                <li>æ¯30åˆ†é’Ÿèµ·èº«æ´»åŠ¨ä¸€æ¬¡</li>
                            </ul>
                        </div>

                        <div class="result-image">
                            <h3>å§¿åŠ¿æ ‡è®°å›¾</h3>
                            <img src="${imgUrl}" alt="å§¿åŠ¿åˆ†æç»“æœ" onerror="this.src='https://images.unsplash.com/photo-1512941937669-90a1b58e7e9c?crop=entropy&cs=tinysrgb&fit=max&fm=jpg&ixid=MnwxfDB8MXxyYW5kb218MHx8cG9zdHVyZXx8fHx8fDE2ODc4MzYyODU&ixlib=rb-4.0.3&q=80&utm_campaign=api-credit&utm_medium=referral&utm_source=unsplash_source&w=1080'">
                            <a href="${imgUrl}" download="å§¿åŠ¿åˆ†æç»“æœ.jpg" class="btn btn-outline">
                                <i>â¬‡ï¸</i> ä¸‹è½½æ ‡è®°å›¾
                            </a>
                        </div>

                        <div class="report-actions">
                            <button class="btn btn-primary" onclick="downloadAnalysisReport(${JSON.stringify(data).replace(/</g, '\\u003c')})">
                                <i>ğŸ“¥</i> ä¸‹è½½å®Œæ•´æŠ¥å‘Š
                            </button>
                        </div>
                    `;
                } catch (error) {
                    console.error("åˆ†æå¼‚å¸¸ï¼š", error);
                    if (error && error.stack) {
                        console.error("å¼‚å¸¸å †æ ˆï¼š", error.stack);
                    }
                    analyzeResult.innerHTML = `
                        <div class="error">
                            <h3>åˆ†æå¤±è´¥</h3>
                            <p>${error.message}</p>
                            <button class="btn btn-primary" onclick="location.reload()">é‡è¯•</button>
                        </div>
                    `;
                }
            });
            analyzeForm.dataset.bound = "true";
        }

        // ä¿®æ”¹ä¸‹è½½æŠ¥å‘Šå‡½æ•° - åŒ¹é…åç«¯æ•°æ®ç»“æ„
        function downloadAnalysisReport(data) {
            // åˆ›å»ºæŠ¥å‘Šå†…å®¹
            const reportContent = `
                SittingWatch å§¿åŠ¿åˆ†ææŠ¥å‘Š
                =========================

                åˆ†ææ—¶é—´: ${new Date().toLocaleString()}

                å§¿åŠ¿æŒ‡æ ‡:
                -------------------------
                è€³è‚©è·ç¦»: ${data.ear_shoulder} cm (${data.posture_status})
                è‚©é«‹è§’åº¦: ${data.shoulder_hip}Â° (${data.posture_status})
                è„ŠæŸ±å¼¯æ›²åº¦: ${data.spine_angle}Â° (${data.hunchback_status})

                å§¿åŠ¿è¯„ä¼°:
                -------------------------
                ${data.posture_status === 'æ­£å¸¸' ?
                    'åå§¿çŠ¶æ€è‰¯å¥½' :
                    'æ£€æµ‹åˆ°åå§¿å¼‚å¸¸' + (data.hunchback_status === 'å¼‚å¸¸' ? 'å’Œé©¼èƒŒç°è±¡' : '')}

                å»ºè®®:
                -------------------------
                1. è°ƒæ•´åº§æ¤…é«˜åº¦ä½¿åŒè„šå¹³æ”¾åœ°é¢
                2. èƒŒéƒ¨æŒºç›´ï¼Œé¿å…å‰å€¾
                3. è°ƒæ•´æ˜¾ç¤ºå™¨é«˜åº¦ä¸è§†çº¿å¹³é½
                4. æ¯30åˆ†é’Ÿèµ·èº«æ´»åŠ¨ä¸€æ¬¡
            `;

            // åˆ›å»ºBlobå¯¹è±¡
            const blob = new Blob([reportContent], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);

            // åˆ›å»ºä¸‹è½½é“¾æ¥
            const a = document.createElement('a');
            a.href = url;
            a.download = `SittingWatch_Report_${new Date().toISOString().slice(0, 10)}.txt`;
            document.body.appendChild(a);
            a.click();

            // æ¸…ç†
            setTimeout(() => {
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
            }, 100);
        }


        // å®æ—¶ç›‘æ§æŒ‰é’®åŠŸèƒ½
        document.getElementById('start-btn').addEventListener('click', function() {
            alert('å®æ—¶ç›‘æµ‹å·²å¯åŠ¨ï¼ç³»ç»Ÿå°†å®æ—¶åˆ†ææ‚¨çš„åå§¿ã€‚');
        });

        document.getElementById('pause-btn').addEventListener('click', function() {
            alert('å®æ—¶ç›‘æµ‹å·²æš‚åœã€‚');
        });
    </script>
</body>
</html>
